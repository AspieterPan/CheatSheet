---
Aliases: 
Tags: Program/System 
DateCreated: 2023-08-28T21:45
DateModified: 2023-08-28T22:06
---
# mmap

## 作为内存区域
---
- mmap 是 Linux 内存模型中的一块区域
	- 类似堆区和栈区
		- 堆区和栈区中存储的程序中的临时变量和全局变量
		- mmap 区中存储的是文件

### 映射关系

- 私有文件映射
	- 多个进程使用同样的物理内存页进行初始化，
	- 但是各个进程对内存文件的修改不会共享，
	- 也不会反应到物理文件中
- 私有匿名映射
	- mmap 会创建一个新的映射，
		- 各个进程不共享，
	- 这种使用主要用于分配内存 (malloc 分配大内存会调用 mmap)
		- 例如开辟新进程时，会为每个进程分配虚拟的地址空间
			- 这些虚拟地址映射的物理内存空间各个进程间读的时候共享
			- 写的时候会 copy-on-write。
- 共享文件映射
	- 多个进程通过虚拟内存技术共享同样的物理内存空间，
	- 对内存文件的修改会反应到实际物理文件中，
	- 也是进程间通信 (IPC) 的一种机制。
- 共享匿名映射
	- 这种机制在进行 fork 的时候不会采用写时复制，
	- 父子进程完全共享同样的物理内存页，
	- 这也就实现了父子进程通信 (IPC)。

> 其中私有映射涉及到一个写时复制 (copy-on-write) 的概念，以下是 chatgpt 生成的内容

- **写时复制（Copy-on-Write）：**
	- 当多个进程共享同一块物理内存时，如果某个进程尝试修改这块内存，操作系统会进行写时复制。
		- 这意味着操作系统会为修改的进程分配一个新的物理内存页，
		- 并将修改的内容复制到这个新的页中。
		- 其他进程仍然共享原始的物理内存页，不受修改的影响。
	- 假设有三个进程 a、b、c 共享了同一个文件，文件被分成了 10 页，然后进程 a 想修改文件的第 2 页。
		- 操作系统会采取类似于写时复制（Copy-on-Write）的机制来处理这个情况。
			1. **初始状态：**
				- 刚开始，三个进程 a、b、c 共享同一块物理内存，
				- 这个物理内存被映射到三个进程的虚拟地址空间中。
			2. **进程 a 修改第 2 页：**
				- 当进程 a 想要修改第 2 页时，
					- 操作系统会为进程 a 分配一块新的物理内存页，
					- 并将原始第 2 页的内容复制到这个新页中。
				- 现在进程 a 修改的是新页中的数据，
				- 其他进程仍然可以访问原始的第 2 页。
			3. **隔离修改：**
				- 这时，进程 a 修改的新页和原始的第 2 页是分开的。
				- 其他进程 b 和 c 仍然访问的是原始的第 2 页，没有看到进程 a 的修改。
		- 这种方式确保了各个进程的隔离性。
			- 如果其他进程 b 或 c 想要修改第 2 页，
				- 操作系统会为它们分别创建新的物理页，
				- 从而确保它们之间的修改不会相互干扰。
		- 需要注意的是，
			- 写时复制机制的实现可能会因操作系统而异，
			- 但总的原则是，当一个进程试图修改一个共享的页时，
			- 操作系统会采取措施确保修改的隔离性，以防止其他进程受到影响。

## 作为库函数
---
- mmap 在 C 语言中是一个库函数
	- 用来在 mmap 区中分配一块空间
	- 与此相对，有一个 munmap 来删除一块映射

```c
#include <sys/mman.h>

// mmap 的函数签名
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);

// munmap 的函数签名
int munmap(void *addr, size_t length);
```

- `addr`：指定映射区域的首地址，通常设置为 `NULL`，由系统自动选择合适的地址。
- `length`：映射的区域大小，以字节为单位。
- `prot`：指定映射区域的保护方式，可以是以下几个标志的组合：
	- `PROT_NONE`：无权限，不能访问。
	- `PROT_READ`：可读。
	- `PROT_WRITE`：可写。
	- `PROT_EXEC`：可执行。
- `flags`：指定映射的标志，可以是以下标志的组合：
	- `MAP_SHARED`：共享映射，多个进程可以共享同一份映射区域。
	- `MAP_PRIVATE`：私有映射，每个进程有自己的映射区域副本。
	- `MAP_ANONYMOUS`：创建匿名映射，不与文件关联，用于实现共享内存。
- `fd`：文件描述符，用于指定要映射的文件。如果不是映射文件，可以传入 -1。
- `offset`：文件的偏移量，指定从文件的哪个位置开始映射。

> 值得注意的是,mmap 只是在虚拟内存分配了地址空间,只有在第一次访问虚拟内存的时候才分配物理内存。
