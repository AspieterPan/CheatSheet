---
Aliases: 
Tags: Computer/Compose 
DateCreated: 2023-08-11T21:09
DateModified: 2023-08-11T21:50
---
# 中断的作用和原理

Top :: [[Computer Compose]] - 第七章 - 输入输出系统 - 7.3.2

## 中断的基本概念
---
- 程序中断是指在计算机执行现行程序的过程中,出现某些急需处理的异常情况或特殊请求,CPU 暂时中止现行程序,而转去对这些异常情况或特殊请求进行处理里,在处理完毕后 CPU 又自动返回到现行程序的断点处,继续执行原程序。
- 工作流程:
	1. 中断请求
		- 中断源向 CPU 发送中断请求信号。
	2. 中断响应
		- 响应中断的条件。
		- 中断判优:
			- 多个中断源同时提出请求时通过中断判优逻辑响应一个中断源。
	3. 中断处理
		- 中断隐指令。
		- 中断服务程序。

## 中断请求的分类
---
- 中断
	- 内中断（也称异常、例外、陷入）
		- 自愿中断——指令中断（又叫陷入指令、trap 指令）
		- 强迫中断
			- 硬件故障（如：缺页）
			- 软件中断（如：整数除 0）
	- 外中断（狭义的中断）
		- 外设请求
		- 人工干预
	- 非屏蔽中断
		- 关中断时也会被响应 (如: 掉电)
	- 可屏蔽中断
		- 关中断时不会被响应

## 中断请求标记
---
- 每个中断源向 CPU 发出中断请求的时间是随机的。
	- 为了记录中断事件并区分不同的中断源,中断系统需对每个中断源设置中断请求标记触发器 INTR,
	- 当其状态为 "1" 时,表示中断源有请求。
	- 这些触发器可组成中断请求标记寄存器,该寄存器可集中在 CPU 中,也可分散在各个中断源中。
- 对于外中断,CPU 是在统一的时刻即每条指令执行阶段结束前向接口发出中断查询信号, 以获取 I/O 的中断请求,也就是说,CPU 响应中断的时间是在每条指令执行阶段的结束时刻。
- CPU 响应中断必须满足以下 3 个条件:
	1. 中断源有中断请求。
	2. CPU 允许中断即开中断。
	3. 一条指令执行完毕,且没有更紧迫的任务。

## 中断判优 - 实现
---
- 中断判优既可以用硬件实现,也可用软件实现:
	- 硬件实现是通过==硬件排队器==实现的,它既可以设置在 CPU 中,也可以分散在各个中断源中;
	- 软件实现是通过==查询程序==实现的。

## 中断判优 - 优先级设置
---
1. 硬件故障中断属于最高级,其次是软件中断;
2. 非屏蔽中断优于可屏蔽中断;
3. DMA 请求优于 I/O 设备传送的中断请求
4. 高速设备优于低速设备;
5. 输入设备优于输出设备;
6. 实时设备优于普通设备。

## 中断处理过程
---
1. 当前指令执行结束后,PC 内容为 K+1
2. 中断隐指令:
	- 保存原程序的 PC 值,并让 PC 指向中断服务程序的第一条指令
3. 进入中断服务程序的方法是把该程序第一条指令的地址放入 PC
4. 回到主程序的方法是把 K+1 放入 PC

### 中断隐指令

- 中断隐指令的主要任务:
	1. 关中断
		- 在中断服务程序中,为了保护中断现场 (即 CPU 主要寄存器中的内容) 期间不被新的中断所打断,必须关中断,从而保证被中断的程序在中断服务程序执行完毕之后能接着正确地执行下去。
	2. 保存断点
		- 为了保证在中断服务程序执行完毕后能正确地返回到原来的程序,必须将原来程序的断点 (即程序计数器 (PC) 的内容) 保存起来。可以存入堆栈,也可以存入指定单元。
	3. 引出中断服务程序
		- 引出中断服务程序的实质就是取出中断服务程序的入口地址并传送给程序计数器 (PC)。

### 硬件向量法

1. 由**硬件**产生**向量地址**
2. 再由**向量地址**找到**入口地址**

> 入口地址相当于函数指针，向量地址相当于指针的指针
> 入口地址可能会随程序的改变而变化，但是向量地址由硬件控制，不会变化

### 中断服务程序

- 中断服务程序的主要任务:
	1. 保护现场
		- 保存通用寄存器和状态寄存器的内容 (eg: 保存 ACC 寄存器的值),以便返回原程序后可以恢复 CPU 环境。可使用堆栈,也可以使用特定存储单元。
	2. 中断服务 (设备服务)
		- 主体部分,如通过程序控制需打印的字符代码送入打印机的缓冲存储器中 (eg: 中断服务的过程中有可能修改 ACC 寄存器的值)
	3. 恢复现场
		- 通过出栈指令或取数指令把之前保存的信息送回寄存器中 (eg: 把原程序算到一半的 ACC 值恢复原样）
	4. 中断返回
		- 通过中断返回指令回到原程序断点处。
